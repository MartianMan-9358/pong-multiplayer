<script>
(function () {
  const {
    insertCoin,
    onPlayerJoin,
    myPlayer,
    isHost,
    setState,
    onStateChange
  } = window.Playroom;

  const joinBtn = document.getElementById('join');
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  canvas.width = 800; canvas.height = 500;

  const state = {
    ball: { x: canvas.width/2, y: canvas.height/2, vx: 4, vy: 3 },
    paddles: { p1: { y: (canvas.height-100)/2 }, p2: { y: (canvas.height-100)/2 } },
    scores: { p1: 0, p2: 0 },
    slot: 'p1',
    hosting: false
  };

  const keys = {};
  window.addEventListener('keydown', e => { keys[e.code] = true; });
  window.addEventListener('keyup',   e => { keys[e.code] = false; });

  function draw() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#fff';
    ctx.fillRect(20, state.paddles.p1.y, 12, 100);
    ctx.fillRect(canvas.width - 32, state.paddles.p2.y, 12, 100);
    ctx.beginPath(); ctx.arc(state.ball.x, state.ball.y, 8, 0, Math.PI * 2); ctx.fill();
    ctx.font = '20px monospace';
    ctx.fillText(state.scores.p1, canvas.width * 0.25, 30);
    ctx.fillText(state.scores.p2, canvas.width * 0.75, 30);
  }

  function applyLocalInput() {
    if (state.slot === 'p1') {
      if (keys['KeyW']) state.paddles.p1.y -= 6;
      if (keys['KeyS']) state.paddles.p1.y += 6;
      state.paddles.p1.y = Math.max(0, Math.min(canvas.height - 100, state.paddles.p1.y));
    } else {
      if (keys['ArrowUp'])   state.paddles.p2.y -= 6;
      if (keys['ArrowDown']) state.paddles.p2.y += 6;
      state.paddles.p2.y = Math.max(0, Math.min(canvas.height - 100, state.paddles.p2.y));
    }
  }

  function throttle(fn, ms) {
    let last = 0;
    return (...a) => {
      const now = Date.now();
      if (now - last >= ms) { last = now; fn(...a); }
    };
  }
  const publishPaddles = throttle(() => { setState('paddles', state.paddles); }, 50);

  let hostTick = null;
  function startHost() {
    if (hostTick) return;
    state.hosting = true;
    hostTick = setInterval(() => {
      const b = state.ball;
      b.x += b.vx; b.y += b.vy;
      if (b.y < 8 || b.y > canvas.height - 8) b.vy *= -1;
      if (b.x - 8 < 32 && b.y > state.paddles.p1.y && b.y < state.paddles.p1.y + 100) b.vx = Math.abs(b.vx);
      if (b.x + 8 > canvas.width - 32 && b.y > state.paddles.p2.y && b.y < state.paddles.p2.y + 100) b.vx = -Math.abs(b.vx);
      if (b.x < 0) { state.scores.p2++; b.x = canvas.width / 2; b.y = canvas.height / 2; b.vx = 4;  b.vy = 3; }
      if (b.x > canvas.width) { state.scores.p1++; b.x = canvas.width / 2; b.y = canvas.height / 2; b.vx = -4; b.vy = -3; }
      setState('ball',   { x: b.x, y: b.y, vx: b.vx, vy: b.vy, ts: Date.now() });
      setState('scores', state.scores);
      setState('paddles',state.paddles);
    }, 1000 / 60);
  }
  function stopHost() {
    state.hosting = false;
    clearInterval(hostTick);
    hostTick = null;
  }

  let stateHooked = false;
  function hookState() {
    if (stateHooked) return;
    stateHooked = true;
    onStateChange('ball',    val => { if (!state.hosting && val) state.ball    = { ...state.ball,    ...val }; });
    onStateChange('paddles', val => { if (val)                    state.paddles = { ...state.paddles, ...val }; });
    onStateChange('scores',  val => { if (val)                    state.scores  = { ...val }; });
  }

  let joined = false;
  async function join() {
    if (joined) return;
    joined = true;
    try {
      await insertCoin();      // opens popup, creates room, appends #r=ROOMID
      hookState();             // subscribe ASAP so clients donâ€™t miss early host updates

      onPlayerJoin(player => {
        const me = myPlayer();
        if (me && player.id === me.id) {
          state.slot = (player.index === 0) ? 'p1' : 'p2';
        }
        if (isHost()) { startHost(); } else { stopHost(); }
      });
    } catch (err) {
      console.error('Playroom join failed:', err);
      joined = false; // allow retry
    }
  }

  function loop() {
    applyLocalInput();
    publishPaddles();
    draw();
    requestAnimationFrame(loop);
  }

  document.getElementById('join').onclick = join;
  loop();
})();
</script>
